<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<script src="eventemitter2.js"></script>
<script src="roslib.min.js"></script>
<script type="text/javascript" type="text/javascript">
// Connecting to ROS
// -----------------
var ros = new ROSLIB.Ros({
url : 'ws://localhost:8081'
});
ros.on('connection', function() {
console.log('Connected to websocket server.');
});
ros.on('error', function(error) {
console.log('Error connecting to websocket server: ', error);
});
ros.on('close', function() {
console.log('Connection to websocket server closed.');
});
// ----------------------

// Buffer for storing incoming images
var imageBuffer = [];
var bufferSize = 10;
var frameRate = 30; // target frames per second (FPS)

var listener = new ROSLIB.Topic({
ros : ros,
name : '/sky360/frames/annotated/compressed',
messageType : 'sensor_msgs/msg/CompressedImage'
});

listener.subscribe(function(message) {
  bufferSize = parseInt(document.getElementById('buffer_size').value);
  if (imageBuffer.length < bufferSize) {
    imageBuffer.push(message);
  }
});

function processImage() {
  frameRate = parseInt(document.getElementById('frame_rate').value);
  if (imageBuffer.length > 0) {
    var message = imageBuffer.shift();
    document.getElementById('image_sub').src = "data:image/jpeg;base64," + message.data;
  }
}

// Process images from buffer at a constant frame rate
setInterval(processImage, 1000 / frameRate);
</script>
</head>
<body>
<h1>Compressed annotated frame sky360</h1>
<label for="buffer_size">Buffer Size:</label>
<input type="number" id="buffer_size" name="buffer_size" min="1" max="100" value="10">
<br>
<label for="frame_rate">Frame Rate (FPS):</label>
<input type="number" id="frame_rate" name="frame_rate" min="1" max="60" value="30">
<br>
<img id="image_sub" />
</body>
</html>
