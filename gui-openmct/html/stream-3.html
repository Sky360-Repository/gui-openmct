<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<script src="../lib/eventemitter2.js"></script>
<script src="../lib/roslib.min.js"></script>
<script type="text/javascript" type="text/javascript">
function init() {
  // Connecting to ROS
  // -----------------
  var ros = new ROSLIB.Ros({
    url : 'ws://localhost:8081'
  });
  ros.on('connection', function() {
    console.log('Connected to websocket server.');
  });
  ros.on('error', function(error) {
    console.log('Error connecting to websocket server: ', error);
  });
  ros.on('close', function() {
    console.log('Connection to websocket server closed.');
  });
  // ----------------------

  // Buffer for storing incoming images
  var imageBuffer = [];
  var bufferSize = 10;
  var frameRate = 30; // target frames per second (FPS)
  var lastFrameTime = null;
  var actualFrameRate = 0;

  var listener = new ROSLIB.Topic({
    ros : ros,
    name : '/sky360/frames/annotated/compressed',
    messageType : 'sensor_msgs/msg/CompressedImage'
  });

  listener.subscribe(function(message) {
    if (document.getElementById('buffer_enabled').checked) {
      if (imageBuffer.length < bufferSize) {
        imageBuffer.push(message);
      }
    } else {
      document.getElementById('image_sub').src = "data:image/jpeg;base64," + message.data;
      updateActualFrameRate();
    }
  });

  function processImage() {
    if (imageBuffer.length > 0 && document.getElementById('buffer_enabled').checked) {
      var message = imageBuffer.shift();
      document.getElementById('image_sub').src = "data:image/jpeg;base64," + message.data;
      updateActualFrameRate();
    }
    setTimeout(processImage, 1000 / frameRate);
  }

  function updateActualFrameRate() {
    var currentTime = new Date().getTime();
    if (lastFrameTime !== null) {
      var timeDifference = currentTime - lastFrameTime;
      actualFrameRate = 1000 / timeDifference;
      document.getElementById('actual_frame_rate').innerText = actualFrameRate.toFixed(2);
    }
    lastFrameTime = currentTime;
  }

  // Call processImage for the first time
  processImage();
}

window.onload = init;
</script>
</head>
<body>
<h1>Compressed annotated frame sky360</h1>
<label for="buffer_enabled">Enable Buffer:</label>
<input type="checkbox" id="buffer_enabled" name="buffer_enabled" checked>
<br>
<label for="buffer_size">Buffer Size:</label>
<input type="number" id="buffer_size" name="buffer_size" min="1" max="100" value="10">
<br>
<label for="frame_rate">Target Frame Rate (FPS):</label>
<input type="number" id="frame_rate" name="frame_rate" min="1" max="60" value="30">
<br>
<label for="actual_frame_rate">Actual Frame Rate (FPS):</label>
<span id="actual_frame_rate">0</span>
<br>
<img id="image_sub" />
</body>
</html>
